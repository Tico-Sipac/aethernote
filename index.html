<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aethernote</title>
  <meta name="description" content="Aethernote - A fluid, offline-first notes application.">
  <meta name="theme-color" content="#0d0221"/>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Default Theme values - these will be controlled by the theme engine */
      --bg-1: #0d0221;      
      --bg-2: #24174d;      
      --accent: #00d5ff;    
      --ink: #f0f0f0;       
      --ink-dim:#a0a0a0;
      --panel-10: rgba(255,255,255,0.08);
      --panel-16: rgba(255,255,255,0.12);
      --panel-24: rgba(255,255,255,0.20);
      --r-sm:10px;
      --r-md:12px;
      --border-thickness: 1px;
      --shadow-1: 0 8px 30px rgba(0,0,0,0.4);
      --shadow-inset: inset 0 0 0 1px rgba(255,255,255,0.1);
      --noise: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0.03 0.06 0.03 0'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='0.25'/></svg>");
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes aurora { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", Arial;
      color:var(--ink);
      background-color: var(--bg-1);
      overflow-x:hidden;
      transition: background .3s ease;
      position: relative;
    }
    #aurora-bg {
      position: fixed; inset: 0; z-index: -1;
      background: radial-gradient(ellipse at top left, var(--accent), transparent 50%), radial-gradient(ellipse at bottom right, var(--bg-2), transparent 50%);
      background-size: 200% 200%; opacity: 0.3; animation: aurora 30s ease-in-out infinite;
    }
    header{
      position:sticky; top:0; z-index:20; display:flex; gap:16px; align-items:center; justify-content:space-between;
      padding:16px 24px; background: linear-gradient(to bottom, var(--panel-24), var(--panel-16));
      backdrop-filter: blur(12px) saturate(1.2); -webkit-backdrop-filter: blur(12px) saturate(1.2);
      border-bottom: var(--border-thickness) solid rgba(255,255,255,0.14);
      border-radius: 0 0 var(--r-md) var(--r-md); box-shadow: var(--shadow-1);
    }
    header::after{
      content:""; position:absolute; inset:0; pointer-events:none; border-radius: 0 0 var(--r-md) var(--r-md);
      background-image: var(--noise); opacity:.15;
    }
    .brand{font-weight:800; letter-spacing:0.4px; font-size:20px}
    .search{ flex:1; display:flex; gap:10px; justify-content:flex-end; position: relative; }
    .search input{
      width:min(620px,100%); padding:10px 40px 10px 16px; border-radius:var(--r-sm);
      border: var(--border-thickness) solid rgba(255,255,255,0.14);
      background: var(--panel-10); color:var(--ink); outline:none;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    }
    .search input::placeholder { color: var(--ink-dim); opacity: 1; }
    .clear-search-btn {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      border: none; background: none; color: var(--accent);
      font-size: 24px; font-weight: 700; cursor: pointer; padding: 0 8px;
      line-height: 1; opacity: 0.7; transition: opacity 0.2s ease;
    }
    .clear-search-btn:hover { opacity: 1; }
    .header-menu { position: relative; display: inline-flex; align-items: center; height: 100%; }
    .btn.icon-only { padding: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
    .dropdown-content {
      display: none; position: absolute; right: 0; top: 100%; margin-top: 8px;
      background-color: var(--bg-2); min-width: 180px; box-shadow: var(--shadow-1);
      border-radius: var(--r-sm); z-index: 1; padding: 8px; border: var(--border-thickness) solid rgba(255, 255, 255, 0.18);
      animation: fadeIn 0.2s ease;
    }
    .dropdown-content button { width: 100%; text-align: left; margin-bottom: 4px; padding: 10px 14px; display: flex; align-items: center; gap: 10px; }
    .dropdown-content button:last-child { margin-bottom: 0; }
    .dropdown-content.show { display: block; }
    .dropdown-content .icon { width: 16px; height: 16px; }
    .shelf-tabs{
      position:fixed; left:16px; top:112px; bottom:112px; width:90px;
      display:flex; flex-direction:column; gap:12px; align-items:stretch;
      z-index:15; pointer-events:none;
    }
    .shelf-tabs .stack{
      overflow:auto; display:flex; flex-direction:column; gap:12px; padding: 6px; pointer-events:auto;
      background: var(--panel-10); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border: var(--border-thickness) solid rgba(255,255,255,0.10); border-radius: var(--r-md);
    }
    .tab-btn{
      border:none; cursor:pointer; border-radius: var(--r-sm); padding:10px 8px; min-height:60px;
      color:var(--ink); background: var(--panel-10); box-shadow: var(--shadow-inset);
      display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
      transition:transform .15s ease, box-shadow .15s ease, background .2s ease;
      word-break:break-word; font-weight:700; font-size:12px; position:relative;
    }
    .tab-btn:hover { box-shadow: var(--shadow-inset), 0 0 12px 1px var(--accent); transform: translateY(-2px); }
    .tab-btn.active{ background: var(--accent) !important; color: var(--bg-1) !important; box-shadow: var(--shadow-1); outline: none; border: none; }
    .tab-btn.add .icon { width: 20px; height: 20px; }
    main{ padding: 24px; padding-left: 130px; padding-bottom:110px; position: relative; }
    .bs-header{
      display:flex; flex-wrap:wrap; align-items:center; gap:12px; padding:16px 20px; border-radius: var(--r-md); margin-bottom:24px;
      background: linear-gradient(to bottom, var(--panel-16), var(--panel-10)); 
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border: var(--border-thickness) solid rgba(255,255,255,0.12); box-shadow: var(--shadow-1); position:relative;
    }
    .bs-header::after{ content:""; position:absolute; inset:0; border-radius: inherit; background-image: var(--noise); opacity:.15; pointer-events:none; }
    .bs-title{ font-weight:800; letter-spacing:0.3px; flex-grow:1; cursor:pointer; }
    .bs-controls{ display:flex; gap:10px; }
    .btn-header{
      border: var(--border-thickness) solid rgba(255,255,255,0.16); padding:10px 14px; border-radius: var(--r-sm);
      background: var(--panel-10); color:var(--ink); cursor:pointer; font-weight:700;
      display: flex; align-items: center; gap: 8px;
    }
    .btn-header .icon { width: 16px; height: 16px; }
    #shelfContainer { position: relative; }
    .shelf-wrap{ 
      margin-bottom:24px; position: absolute;
      transition: top 0.3s ease, left 0.3s ease, opacity 0.3s ease;
      width: 380px; animation: fadeIn 0.4s ease forwards;
    }
    .shelf-bar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 16px; border-radius: var(--r-sm); color:var(--ink); font-weight:800; letter-spacing:0.2px;
      background: linear-gradient(to bottom, var(--panel-16), var(--panel-10)); 
      border: var(--border-thickness) solid rgba(255,255,255,0.12);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      box-shadow: var(--shadow-inset), var(--shadow-1); position:relative;
    }
    .shelf-bar::after{ content:""; position:absolute; inset:0; border-radius: inherit; background-image: var(--noise); opacity:.15; pointer-events:none; }
    .shelf-name{ flex-grow:1; cursor:pointer; }
    .shelf-controls{ display:flex; gap:8px; align-items:center; }
    .btn-shelf{
      cursor:pointer; border: var(--border-thickness) solid rgba(255,255,255,0.14);
      background: var(--panel-10); color:var(--ink); padding: 0;
      width: 40px; height: 40px; border-radius: var(--r-sm);
      display: flex; align-items: center; justify-content: center;
    }
    .btn-shelf .icon { width: 18px; height: 18px; }
    .add-book-btn{
      cursor:pointer; border: var(--border-thickness) solid rgba(255,255,255,0.16);
      padding:0; border-radius: var(--r-sm); color:var(--ink); background:var(--panel-10);
      width:40px; height:40px; display:flex; align-items:center; justify-content:center;
    }
    .add-book-btn .icon { width: 20px; height: 20px; }
    .shelf-body{
      margin-top:16px; padding:16px; border-radius: var(--r-md); background: var(--panel-10);
      display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; border: var(--border-thickness) solid rgba(255,255,255,0.1);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); position:relative;
    }
    .shelf-body::after{ content:""; position:absolute; inset:0; background-image: var(--noise); opacity:.15; border-radius: inherit; pointer-events:none; }
    .book, .book-add{
      width:100%; border-radius: var(--r-sm); color:#fff; font-weight:700;
      display:flex; align-items: center;
      justify-content:center; text-align:center; cursor:pointer; 
      box-shadow: var(--shadow-1), var(--shadow-inset); transition: transform .2s ease, box-shadow .2s ease;
      position:relative; padding: 12px;
      white-space: normal; word-break: break-word; line-height: 1.3;
      font-size: 15px; animation: fadeIn 0.4s ease forwards;
    }
    .book:hover{ transform: translateY(-4px) scale(1.03); box-shadow: 0 12px 28px rgba(0,0,0,0.4), 0 0 12px 2px var(--accent); }
    .book-add .icon { width: 28px; height: 28px; }
    .shelf-shortcut {
      position: absolute; top: -8px; right: -8px; width: 24px; height: 24px;
      border-radius: 50%; background: var(--accent); color: var(--bg-1);
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 5;
    }
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:30; background: radial-gradient(1200px 800px at 50% 20%, rgba(0,0,0,0.55), rgba(0,0,0,0.7)); }
    .overlay.show{ display:flex }
    .modal{
      width:min(720px, 96%); background: linear-gradient(to bottom, var(--panel-24), var(--panel-16));
      border: var(--border-thickness) solid rgba(255,255,255,0.18); border-radius: var(--r-md); padding:16px; color:var(--ink);
      box-shadow: 0 30px 80px rgba(0,0,0,0.45); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); position:relative;
      display: flex; flex-direction: column; max-height: 90vh;
      animation: scaleUp 0.3s ease;
    }
    .modal::after{ content:""; position:absolute; inset:0; background-image: var(--noise); opacity:.15; border-radius: inherit; pointer-events:none; }
    .modal h3{ margin:0 0 12px 0; font-size:18px; }
    .modal .input-wrapper { position: relative; }
    .modal .input-wrapper::after{
      content:""; position:absolute; inset:0; background-image: var(--noise); opacity:.15;
      background-color: var(--panel-10); border-radius: var(--r-sm); pointer-events:none; z-index: 1;
    }
    .modal textarea, .modal input[type="text"] {
      width:100%; padding:12px; border-radius: var(--r-sm);
      border: var(--border-thickness) solid rgba(255,255,255,0.1); background: transparent; color:var(--ink); outline: none;
      position: relative; z-index: 2;
    }
    .modal textarea::placeholder, .modal input::placeholder { color: var(--ink-dim); opacity: 1; }
    .modal textarea{ min-height:140px; resize: vertical; flex-grow: 1; }
    .modal .actions{ margin-top:16px; display:flex; gap:12px; justify-content:space-between; align-items:center; flex-shrink: 0; }
    .modal .actions .left-actions, .modal .actions .right-actions{ display:flex; gap:8px; }
    .btn{ 
      border: var(--border-thickness) solid rgba(255,255,255,0.18); padding:10px 14px; border-radius: var(--r-sm); 
      cursor:pointer; font-weight:700; background: var(--panel-10); color:var(--ink);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn:hover { box-shadow: 0 0 12px 1px var(--accent); transform: translateY(-2px); }
    .btn.primary{ background:var(--accent); color:var(--bg-1); border-color:rgba(0,0,0,0.1) }
    .btn.danger{ background:#e14444; color:#fff; border-color: rgba(0,0,0,0.12) }
    .modal .actions .btn.icon-btn {
      width: 44px; height: 44px; display: flex;
      align-items: center; justify-content: center; padding: 0;
    }
    .modal .actions .btn.icon-btn .icon { width: 20px; height: 20px; }
    .modal .right-actions .btn:not(.icon-btn) { width: auto; height: auto; padding: 10px 14px; }
    .tags-section { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
    .tags-input-wrapper { display: flex; gap: 8px; align-items: center; }
    .tags-input-wrapper input { flex-grow: 1; width: auto; min-width: 120px; }
    .tags-display { display: flex; flex-wrap: wrap; gap: 6px; padding: 4px; min-height: 28px; }
    .tag-item {
      background: var(--accent); color: var(--bg-1); font-size: 12px; font-weight: 700;
      padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 6px;
    }
    .tag-item .delete-tag { cursor: pointer; font-weight: 900; }
    .theme-list { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
      gap: 10px; margin-top: 10px; max-height: 60vh; overflow-y: auto; 
    }
    .theme-card { padding: 12px; border-radius: var(--r-sm); cursor: pointer; border: 2px solid transparent; transition: border .2s ease; position: relative; }
    .theme-card.active { border-color: var(--accent); }
    .theme-card h4 { margin: 0 0 8px 0; font-size: 14px; }
    .theme-swatches { display: flex; gap: 4px; }
    .swatch { width: 20px; height: 20px; border-radius: 4px; }
    .delete-theme-btn {
      position: absolute; top: 4px; right: 4px; width: 24px; height: 24px;
      background: rgba(0,0,0,0.3); color: #fff; border: none; border-radius: 50%;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .global-tags-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; max-height: 50vh; overflow-y: auto; }
    .global-tags-list .tag-btn { background: var(--panel-16); color: var(--ink); border: var(--border-thickness) solid rgba(255,255,255,0.1); padding: 6px 12px; border-radius: var(--r-sm); cursor: pointer; }
    
    /* Icon styling fixes */
    .icon { display: flex; align-items: center; justify-content: center; }
    .btn .icon { width: 16px; height: 16px; }
    .btn-header .icon { width: 16px; height: 16px; }
    .btn-shelf .icon { width: 18px; height: 18px; }
    .add-book-btn .icon { width: 20px; height: 20px; }
    .book-add .icon { width: 28px; height: 28px; }
    .tab-btn.add .icon { width: 20px; height: 20px; }
    
    @media (max-width:720px){
      .shelf-tabs{ left:0; right:0; width:auto; top:auto; bottom:0; height:84px; display:block;}
      .shelf-tabs .stack{ flex-direction:row; gap:10px; padding:12px; overflow:auto; background: linear-gradient(to top, var(--panel-24), var(--panel-16)); border-radius: var(--r-md) var(--r-md) 0 0; }
      .tab-btn{ min-height:56px; min-width:76px; }
      main { padding: 16px; padding-bottom: 110px; }
            .shelf-body{ 
        grid-template-columns: repeat(3, 1fr); 
        gap: 10px; /* This reduces the space between books from 16px to 10px */
      }
      .book, .book-add{ 
        height: auto; /* Allow height to be determined by the aspect ratio */
        aspect-ratio: 1 / 1.4; /* Enforces the exact ratio you want */
        font-size: 14px; 
        padding: 12px; 
      }
      .shelf-wrap { position: relative !important; width: 100% !important; left: auto !important; top: auto !important; opacity: 1 !important; }
      .overlay { align-items: flex-start; padding-top: 5vh; }
      .modal { max-height: 85vh; }
      .modal textarea { min-height: 40vh; }
      .tags-input-wrapper { flex-direction: column; align-items: flex-start; }
      .tags-input-wrapper input { width: 100%; }
      .theme-list { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 721px) {
      .book, .book-add { height: auto; aspect-ratio: 1 / 1.4; }
    }
  </style>
</head>
<body>
  <div id="aurora-bg"></div>
  <header>
    <div class="brand">Aethernote</div>
    <div class="search">
      <input id="globalSearch" type="search" placeholder="Search notes (tags, title, content)..." />
      <button id="clearSearchBtn" class="clear-search-btn" style="display: none;" title="Clear search">&times;</button>
    </div>
    <div class="header-menu">
      <button id="menuBtn" class="btn icon-only" title="Menu"></button>
      <div id="menuDropdown" class="dropdown-content">
        <button class="btn" id="saveBtn" title="Export to File"></button>
        <button class="btn" id="loadBtn" title="Import from File"></button>
        <button class="btn" id="themesBtn" title="Change Theme"></button>
        <button class="btn" id="tagsBtn" title="View All Tags"></button>
        <button class="btn" id="updateBtn" title="Force update from server"></button>
      </div>
    </div>
  </header>
  <div class="shelf-tabs"><div class="stack" id="tabsStack"></div></div>
  <main id="main"></main>
  <div class="overlay" id="overlay"></div>
  <script>
    (function(){
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registered!'))
            .catch(err => console.log('Service Worker registration failed: ', err));
        });
      }
      
      const APP_KEY = 'aethernote.v9-advanced-theming';
      const THEMES_KEY = 'aethernote.themes.v3';
      let state = { bookshelves: [], active: 0, activeTheme: 'Cyber Glow' };
      let userThemes = [];
      let systemThemes = [];
      let isModalOpen = false;
      let activeModalCloseHandler = null;

      const main = document.getElementById('main');
      const tabsStack = document.getElementById('tabsStack');
      const overlay = document.getElementById('overlay');
      const globalSearch = document.getElementById('globalSearch');

      function newId(){ return 'id-' + Math.random().toString(36).slice(2); }
      function safe(s) { return (s || '').replace(/"/g, '&quot;'); }
      function createEl(tag, props = {}) {
        const el = document.createElement(tag);
        Object.entries(props).forEach(([k, v]) => {
          if (k === 'innerHTML') el.innerHTML = v;
          else if (k in el) el[k] = v; 
          else el.setAttribute(k, v);
        });
        return el;
      }

      const BASKETS = [
        ['#4a90e2','#5dade2','#2874a6','#1b4d97'], ['#d35400','#e67e22','#ca6f1e','#7e5109'],
        ['#27ae60','#2ecc71','#16a085','#196f3d'], ['#8e44ad','#9b59b6','#c39bd3','#d98880']
      ];
      function pickFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
      function pickTwoDifferentIndexes(n){ const a = Math.floor(Math.random()*n); let b = Math.floor(Math.random()*n); if(b === a) b = (b+1)%n; return [a,b]; }
      function crossBasketGradient(){ const [bi, bj] = pickTwoDifferentIndexes(BASKETS.length); return [pickFrom(BASKETS[bi]), pickFrom(BASKETS[bj])]; }
      
      function normalizeState(s) {
        (s.bookshelves || []).forEach(bs => {
          if (!bs.id) bs.id = newId();
          (bs.shelves || []).forEach(sh => { 
            if (!sh.id) sh.id = newId();
            if (!sh.addGradient) sh.addGradient = crossBasketGradient();
            (sh.books || []).forEach(bk => {
              if (!bk.id) bk.id = newId();
              if (!bk.gradient) bk.gradient = crossBasketGradient();
              if (!bk.tags) bk.tags = [];
            });
          });
        });
      }
      function saveToStorage(){ localStorage.setItem(APP_KEY, JSON.stringify(state)); }
      function loadFromStorage(){
        const raw = localStorage.getItem(APP_KEY);
        if(raw){
          try { state = JSON.parse(raw); normalizeState(state); }
          catch (e) { console.error("Failed to parse state", e); state = { bookshelves: [], active: 0, activeTheme: 'Cyber Glow' }; }
        }
      }
      function modifyState(callback, shouldRender = true) {
        callback(state);
        saveToStorage();
        if (shouldRender) render();
      }

      function layoutShelves() {
        const shelfContainer = document.getElementById('shelfContainer');
        if (!shelfContainer) return;
        if (window.innerWidth < 721 || globalSearch.value) {
          shelfContainer.style.height = 'auto';
          shelfContainer.querySelectorAll('.shelf-wrap').forEach(shelf => {
            shelf.style.position = ''; shelf.style.left = ''; shelf.style.top = ''; shelf.style.width = ''; shelf.style.opacity = '';
          });
          return;
        }
        const shelves = Array.from(shelfContainer.querySelectorAll('.shelf-wrap'));
        if (shelves.length === 0) { shelfContainer.style.height = '0px'; return; }
        const gap = 24; const shelfWidth = 380; const containerWidth = shelfContainer.offsetWidth;
        const numColumns = Math.max(1, Math.floor((containerWidth + gap) / (shelfWidth + gap)));
        const columnHeights = new Array(numColumns).fill(0);
        shelves.forEach(shelf => {
          shelf.style.width = shelfWidth + 'px';
          const shelfHeight = shelf.offsetHeight;
          let minColIndex = 0;
          for (let i = 1; i < numColumns; i++) if (columnHeights[i] < columnHeights[minColIndex]) minColIndex = i;
          shelf.style.position = 'absolute';
          shelf.style.left = (minColIndex * (shelfWidth + gap)) + 'px';
          shelf.style.top = columnHeights[minColIndex] + 'px';
          shelf.style.opacity = '1';
          columnHeights[minColIndex] += shelfHeight + gap;
        });
        shelfContainer.style.height = Math.max(...columnHeights) + 'px';
      }
      const debouncedLayout = debounce(layoutShelves, 250);
      window.addEventListener('resize', debouncedLayout);
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => { clearTimeout(timeout); func(...args); };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      function showOverlay(content, closeHandler = null) {
        activeModalCloseHandler = closeHandler;
        overlay.innerHTML = ''; overlay.appendChild(content); overlay.classList.add('show');
        if (!isModalOpen) { history.pushState({ modal: true }, null); isModalOpen = true; }
      }
      function hideOverlay() {
        activeModalCloseHandler = null;
        overlay.classList.remove('show'); overlay.innerHTML = '';
        if (isModalOpen) { if (history.state && history.state.modal) history.back(); isModalOpen = false; }
      }
      window.addEventListener('popstate', (event) => {
        if (isModalOpen) {
          if (typeof activeModalCloseHandler === 'function') {
            activeModalCloseHandler();
          }
          isModalOpen = false;
          overlay.classList.remove('show');
          overlay.innerHTML = '';
        }
      });
      function promptText(title, placeholder='Name', initial=''){
        return new Promise(resolve => {
          const modal = createEl('div', { className: 'modal' });
          modal.innerHTML = `<h3>${safe(title)}</h3>
            <div class="row input-wrapper"><input type="text" id="promptInput" placeholder="${safe(placeholder)}" value="${safe(initial)}"/></div>
            <div class="actions"><div class="left-actions"></div><div class="right-actions">
              <button class="btn ghost" id="cancelBtn">Cancel</button>
              <button class="btn primary" id="okBtn">OK</button>
            </div></div>`;
          const close = (value) => { hideOverlay(); resolve(value); };
          showOverlay(modal, () => close(null));
          const input = document.getElementById('promptInput'); input.focus(); input.select();
          modal.querySelector('#cancelBtn').onclick = () => close(null);
          modal.querySelector('#okBtn').onclick = () => close(input.value.trim() || null);
          input.onkeydown = e => { if(e.key === 'Enter') { e.preventDefault(); modal.querySelector('#okBtn').click(); }};
        });
      }
      function confirmAction(message) {
        return new Promise(resolve => {
          const modal = createEl('div', { className: 'modal' });
          modal.innerHTML = `<h3>Confirm Action</h3><p>${safe(message)}</p>
            <div class="actions"><div></div><div class="right-actions">
              <button class="btn ghost" id="cancelBtn">Cancel</button>
              <button class="btn danger" id="okBtn">Confirm</button>
            </div></div>`;
          const close = (value) => { hideOverlay(); resolve(value); };
          showOverlay(modal, () => close(false));
          modal.querySelector('#cancelBtn').onclick = () => close(false);
          modal.querySelector('#okBtn').onclick = () => close(true);
        });
      }
      function editBook(book, bsIndex, shelfIndex, bookIndex){
        const modal = createEl('div', { className: 'modal' });
        modal.innerHTML = `<h3>${safe(book.title)}</h3>`;
        const textarea = createEl('textarea', { id: 'noteArea', placeholder: 'Write your note...' });
        textarea.value = book.content || '';
        const tagsSection = createEl('div', { className: 'tags-section' });
        const tagsInputWrapper = createEl('div', { className: 'tags-input-wrapper input-wrapper' });
        const tagsInput = createEl('input', { type: 'text', placeholder: 'Add a tag and press Enter...' });
        const tagsDisplay = createEl('div', { className: 'tags-display' });
        tagsInputWrapper.append(tagsInput); tagsSection.append(tagsInputWrapper, tagsDisplay);
        const renderTags = () => {
          tagsDisplay.innerHTML = '';
          (book.tags || []).forEach((tag, tagIndex) => {
            const tagItem = createEl('div', { className: 'tag-item', textContent: tag });
            const deleteTagBtn = createEl('span', { className: 'delete-tag', innerHTML: '&times;', title: 'Remove tag' });
            deleteTagBtn.onclick = () => { book.tags.splice(tagIndex, 1); renderTags(); };
            tagItem.append(deleteTagBtn); tagsDisplay.append(tagItem);
          });
        };
        renderTags();
        const addPendingTag = () => {
          const newTag = tagsInput.value.trim().toLowerCase();
          if (newTag && !(book.tags || []).includes(newTag)) { book.tags.push(newTag); renderTags(); }
          tagsInput.value = '';
        };
        tagsInput.onkeydown = e => { if (e.key === 'Enter') { e.preventDefault(); addPendingTag(); }};
        const actions = createEl('div', { className: 'actions' });
        const leftActions = createEl('div', { className: 'left-actions' });
        const rightActions = createEl('div', { className: 'right-actions' });
        actions.append(leftActions, rightActions);
        const icons = getIconsForTheme(getThemeByName(state.activeTheme));
        const renameBtn = createEl('button', {className: 'btn ghost icon-btn', title: 'Rename', innerHTML: `<span class="icon">${icons.rename}</span>` });
        const deleteBtn = createEl('button', {className: 'btn danger icon-btn', title: 'Delete', innerHTML: `<span class="icon">${icons.trash}</span>` });
        const closeBtn  = createEl('button', {className: 'btn ghost icon-btn', title: 'Close', innerHTML: `<span class="icon">${icons.chevronDown}</span>` });
        const saveBtn   = createEl('button', {className: 'btn primary icon-btn', title: 'Save', innerHTML: `<span class="icon">${icons.check}</span>` });
        leftActions.append(renameBtn, deleteBtn); rightActions.append(closeBtn, saveBtn);
        modal.append(textarea, tagsSection, actions);
        
        const doSaveAndClose = () => {
          book.content = textarea.value; addPendingTag();
          modifyState(s => { s.bookshelves[bsIndex].shelves[shelfIndex].books[bookIndex] = book; });
          hideOverlay();
        };

        showOverlay(modal, doSaveAndClose);

        textarea.focus();
        renameBtn.onclick = async () => {
          const newTitle = await promptText('Rename Book', 'New book title', book.title);
          if (newTitle) { book.title = newTitle; modal.querySelector('h3').textContent = newTitle; }
        };
        deleteBtn.onclick = async () => { if (await confirmAction(`Delete "${book.title}"?`)) {
            hideOverlay(); modifyState(s => s.bookshelves[bsIndex].shelves[shelfIndex].books.splice(bookIndex, 1));
          }};
        closeBtn.onclick = doSaveAndClose; saveBtn.onclick = doSaveAndClose;
        overlay.onclick = e => { if(e.target === overlay) doSaveAndClose(); };
      }
      function enableInlineEdit(element, onSave) {
          element.onclick = (e) => {
          e.stopPropagation(); if (element.querySelector('input')) return;
          const currentText = element.textContent;
          const input = createEl('input', { type: 'text', value: currentText });
          element.innerHTML = ''; element.appendChild(input); input.focus(); input.select();
          const save = () => {
            const newText = input.value.trim();
            element.textContent = (newText && newText !== currentText) ? newText : currentText;
            if (newText && newText !== currentText) onSave(newText);
            input.removeEventListener('blur', save); input.removeEventListener('keydown', handleKeydown);
          };
          const handleKeydown = (e) => {
            if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
            if (e.key === 'Escape') { input.value = currentText; input.blur(); }
          };
          input.addEventListener('blur', save); input.addEventListener('keydown', handleKeydown);
        };
      }

      const SYSTEM_THEMES = [
        { 
          name: 'Cyber Glow', 
          isSystem: true, 
          styles: {
            colors: { 
              '--bg-1': '#0d0221', 
              '--bg-2': '#24174d', 
              '--accent': '#00d5ff', 
              '--ink': '#f0f0f0', 
              '--ink-dim':'#a0a0a0', 
              '--panel-10': 'rgba(36, 23, 77, 0.6)',   /* from --bg-2 */
              '--panel-16': 'rgba(13, 2, 33, 0.6)',    /* from --bg-1 */
              '--panel-24': 'rgba(36, 23, 77, 0.7)',   /* from --bg-2 */
              '--panel-border': 'rgba(255, 255, 255, 0.1)'
            },
            dimensions: { 
              '--r-sm': '10px', 
              '--r-md': '12px', 
              '--border-thickness': '1px' 
            },
            shadows: { 
              '--shadow-1': '0 8px 30px rgba(13, 2, 33, 0.4)', /* from --bg-1 */
              '--shadow-inset': 'inset 0 0 0 1px rgba(255, 255, 255, 0.1)' 
            }
          }
        },
        { 
          name: 'Soft Material', 
          isSystem: true, 
          styles: {
            colors: { 
              '--bg-1': '#F4F6F8', 
              '--bg-2': '#FFFFFF', 
              '--accent': '#3498DB', 
              '--ink': '#2C3E50', 
              '--ink-dim': '#7F8C8D', 
              '--panel-10': 'rgba(255, 255, 255, 0.5)', /* from --bg-2 */
              '--panel-16': 'rgba(244, 246, 248, 0.5)', /* from --bg-1 */
              '--panel-24': 'rgba(255, 255, 255, 0.6)', /* from --bg-2 */
              '--panel-border': 'rgba(0, 0, 0, 0.1)'
            },
            dimensions: { 
              '--r-sm': '8px', 
              '--r-md': '16px', 
              '--border-thickness': '1px' 
            },
            shadows: { 
              '--shadow-1': '0 4px 12px rgba(220, 220, 220, 0.5)', /* derived from backgrounds */
              '--shadow-inset': 'inset 0 1px 2px rgba(0, 0, 0, 0.05)' 
            }
          }
        },
      ];
      const ICONS = {
        default: {
          menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>`,
          save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
          load: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
          themes: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
          tags: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.586 2.586a2 2 0 0 0-2.828 0L2.172 10.172a2 2 0 0 0 0 2.828l9.192 9.192a2 2 0 0 0 2.828 0l7.586-7.586a2 2 0 0 0 0-2.828z"/><circle cx="8.5" cy="8.5" r="1.5"/></svg>`,
          update: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`,
          plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
          trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`,
          rename: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>`,
          check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
          chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>`,
          chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>`,
        }
      };
      
      function cleanSvg(svgString) {
        return svgString.replace(/<style.*?<\/style>/g, '')
                        .replace(/<defs>.*?<\/defs>/g, '')
                        .replace(/class="[^"]*"/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();
      }
      
      function getIconsForTheme(theme) {
        const themeIcons = (theme && theme.styles && theme.styles.icons) || {};
        const mergedIcons = {...ICONS.default};
        Object.keys(themeIcons).forEach(key => {
          if (themeIcons[key]) {
            mergedIcons[key] = cleanSvg(themeIcons[key]);
          }
        });
        return mergedIcons;
      }
      
      function applyTheme(theme) {
        if (!theme || !theme.styles) return;
        for (const category in theme.styles) {
          if (category !== 'icons') {
            for (const key in theme.styles[category]) {
              document.documentElement.style.setProperty(key, theme.styles[category][key]);
            }
          }
        }
        modifyState(s => s.activeTheme = theme.name, false);
        render();
      }
      
      function loadUserThemes() { 
        const raw = localStorage.getItem(THEMES_KEY); 
        if(raw) userThemes = JSON.parse(raw); 
      }
      
      function saveUserThemes() { 
        localStorage.setItem(THEMES_KEY, JSON.stringify(userThemes)); 
      }
      
      async function loadSystemThemes() {
        try {
          const response = await fetch('./themes.json');
          if (response.ok) {
            const themesData = await response.json();
            if (themesData.themes && Array.isArray(themesData.themes)) {
              return themesData.themes.map(theme => ({ ...theme, isSystem: true }));
            }
            console.error('Invalid themes.json format');
            return [];
          }
        } catch (error) {
          console.error('Failed to load themes.json', error);
        }
        return [];
      }
      
      function getAllThemes() { 
        return [...SYSTEM_THEMES, ...systemThemes, ...userThemes]; 
      }
      
      function getThemeByName(name) { 
        return getAllThemes().find(t => t.name === name) || SYSTEM_THEMES[0]; 
      }
      
      function showThemesModal() {
        const modal = createEl('div', { className: 'modal' });
        modal.innerHTML = `<h3>Themes</h3>`;
        const themeList = createEl('div', { className: 'theme-list' });
        
        const renderThemeList = () => {
            themeList.innerHTML = '';
            getAllThemes().forEach(theme => {
                const card = createEl('div', { className: 'theme-card' + (state.activeTheme === theme.name ? ' active' : '') });
                card.onclick = () => { 
                  applyTheme(theme);
                  document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
                  card.classList.add('active');
                };
                card.innerHTML = `<h4>${safe(theme.name)}</h4>`;
                const swatches = createEl('div', { className: 'theme-swatches' });
                ['--bg-1', '--bg-2', '--accent', '--ink'].forEach(key => {
                    if(theme.styles.colors[key]) {
                      const swatch = createEl('div', { className: 'swatch' });
                      swatch.style.backgroundColor = theme.styles.colors[key];
                      swatches.appendChild(swatch);
                    }
                });
                card.append(swatches);
                if (!theme.isSystem) {
                    const deleteBtn = createEl('button', { className: 'delete-theme-btn', innerHTML: '&times;' });
                    deleteBtn.onclick = async (e) => {
                        e.stopPropagation();
                        if (await confirmAction(`Delete theme "${theme.name}"?`)) {
                            userThemes = userThemes.filter(t => t.name !== theme.name);
                            saveUserThemes();
                            renderThemeList();
                        }
                    };
                    card.appendChild(deleteBtn);
                }
                themeList.appendChild(card);
            });
        };
        
        renderThemeList();
        const actions = createEl('div', { className: 'actions' });
        const rightActions = createEl('div', { className: 'right-actions' });
        const loadBtn = createEl('button', { className: 'btn', textContent: 'Load Theme' });
        const closeBtn = createEl('button', { className: 'btn ghost', textContent: 'Close' });
        loadBtn.onclick = () => {
            const input = createEl('input', { type: 'file', accept: '.json' });
            input.onchange = e => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const newTheme = JSON.parse(event.target.result);
                        if (!newTheme.name || !newTheme.styles) { alert('Invalid theme file: Missing "name" or "styles" property.'); return; }
                        const existingUserThemeIndex = userThemes.findIndex(t => t.name.toLowerCase() === newTheme.name.toLowerCase());
                        if (existingUserThemeIndex > -1) {
                            if (await confirmAction(`A custom theme named "${newTheme.name}" already exists. Do you want to overwrite it?`)) {
                                userThemes[existingUserThemeIndex] = newTheme;
                            } else { return; }
                        } else { userThemes.push(newTheme); }
                        saveUserThemes(); renderThemeList(); applyTheme(newTheme);
                    } catch (err) { alert(`Could not load theme. Error: ${err.message}`); console.error("Theme load error:", err); }
                };
                reader.readAsText(file);
            };
            input.click();
        };
        closeBtn.onclick = hideOverlay;
        rightActions.append(loadBtn, closeBtn); actions.append(createEl('div'), rightActions);
        modal.append(themeList, actions); showOverlay(modal, hideOverlay);
      }
      
      function render() {
        const icons = getIconsForTheme(getThemeByName(state.activeTheme));
        const searchVal = (globalSearch.value || '').trim().toLowerCase();
        main.innerHTML = ''; renderTabs(icons);
        const header = renderBookshelfHeader(state.bookshelves[state.active], state.active, icons);
        main.appendChild(header);
        const shelfContainer = createEl('div', { id: 'shelfContainer' });
        if (searchVal) {
            renderSearchResults(searchVal, shelfContainer, icons);
        } else {
            if (!state.bookshelves.length) { renderEmptyState(icons); return; }
            const currentBS = state.bookshelves[state.active];
            if (currentBS && currentBS.shelves) {
                currentBS.shelves.forEach((shelf, shelfIndex) => {
                    shelfContainer.appendChild(renderShelf(shelf, state.active, shelfIndex, icons));
                });
            }
        }
        main.appendChild(shelfContainer);
        setTimeout(layoutShelves, 50);
      }
      
      function renderTabs(icons) {
        tabsStack.innerHTML = '';
        state.bookshelves.forEach((bs, i) => {
          const b = createEl('button', { className: 'tab-btn' + (state.active === i ? ' active' : ''), title: bs.name, textContent: bs.name });
          b.onclick = () => modifyState(s => s.active = i);
          tabsStack.appendChild(b);
        });
        const add = createEl('button', { className: 'tab-btn add', title: 'Add bookshelf', innerHTML: `<span class="icon">${icons.plus}</span>`});
        add.onclick = async () => {
          const name = await promptText('New Bookshelf', 'Bookshelf name');
          if (name) modifyState(s => { s.bookshelves.push({ id: newId(), name, shelves: [] }); s.active = s.bookshelves.length - 1; });
        };
        tabsStack.appendChild(add);
      }
      
      function renderEmptyState(icons) {
        const empty = createEl('div', { className: 'bs-header' });
        empty.innerHTML = `<div class="bs-title">No bookshelves yet</div>`;
        const btn = createEl('button', { className: 'btn-header', innerHTML: `<span class="icon">${icons.plus}</span>Create your first bookshelf` });
        btn.onclick = async () => {
          const name = await promptText('New Bookshelf', 'Bookshelf name');
          if (name) modifyState(s => { s.bookshelves.push({ id: newId(), name, shelves: [] }); s.active = 0; });
        };
        empty.appendChild(btn); main.innerHTML = ''; main.appendChild(empty);
      }
      
      function renderBookshelfHeader(bs, bsIndex, icons) {
        if (!bs) { renderEmptyState(icons); return createEl('div'); }
        const header = createEl('div', { className: 'bs-header' });
        const title = createEl('div', { className: 'bs-title', textContent: bs.name });
        enableInlineEdit(title, (newName) => modifyState(s => s.bookshelves[bsIndex].name = newName));
        const controls = createEl('div', { className: 'bs-controls' });
        const addShelfBtn = createEl('button', { className: 'btn-header', innerHTML: `<span class="icon">${icons.plus}</span>Shelf` });
        addShelfBtn.onclick = async () => {
          const name = await promptText('New Shelf', 'Shelf name');
          if (name) modifyState(s => { s.bookshelves[bsIndex].shelves.push({ id: newId(), name, collapsed: false, books: []}); });
        };
        const deleteBSBtn = createEl('button', { className: 'btn-header', innerHTML: `<span class="icon">${icons.trash}</span>Delete Bookshelf` });
        deleteBSBtn.onclick = async () => {
          if (await confirmAction(`Delete bookshelf "${bs.name}"?`)) {
            modifyState(s => { s.bookshelves.splice(bsIndex, 1); s.active = Math.max(0, s.active - 1); });
          }
        };
        controls.append(addShelfBtn, deleteBSBtn); header.append(title, controls); return header;
      }
      
      function renderShelf(shelf, bsIndex, shelfIndex, icons) {
        const wrap = createEl('div', { className: 'shelf-wrap', 'data-shelf-id': shelf.id });
        const bar = createEl('div', { className: 'shelf-bar' });
        const name = createEl('div', { className: 'shelf-name', textContent: shelf.name });
        enableInlineEdit(name, (newName) => modifyState(s => s.bookshelves[bsIndex].shelves[shelfIndex].name = newName));
        if (shelfIndex < 10) {
          const shortcut = createEl('div', { className: 'shelf-shortcut', textContent: shelfIndex === 9 ? '0' : (shelfIndex + 1).toString() });
          bar.appendChild(shortcut);
        }
        const ctrls = createEl('div', { className: 'shelf-controls' });
        const [addG1, addG2] = shelf.addGradient || (shelf.addGradient = crossBasketGradient());
        const addB = createEl('button', { className: 'add-book-btn', innerHTML: `<span class="icon">${icons.plus}</span>` });
        addB.style.background = `linear-gradient(135deg, ${addG1}, ${addG2})`;
        addB.onclick = async () => {
          const title = await promptText('New Book', 'Book title');
          if (title) { modifyState(s => s.bookshelves[bsIndex].shelves[shelfIndex].books.push({ id: newId(), title, content: '', tags: [], gradient: crossBasketGradient() })); }
        };
        const delShelf = createEl('button', { className: 'btn-shelf delete-btn', innerHTML: `<span class="icon">${icons.trash}</span>` });
        delShelf.onclick = async () => {
          if (await confirmAction(`Delete shelf "${shelf.name}"?`)) {
            modifyState(s => s.bookshelves[bsIndex].shelves.splice(shelfIndex, 1));
          }
        };
        const collIcon = shelf.collapsed ? icons.chevronRight : icons.chevronDown;
        const coll = createEl('button', { className: 'btn-shelf', innerHTML: `<span class="icon">${collIcon}</span>` });
        coll.onclick = () => {
          modifyState(s => s.bookshelves[bsIndex].shelves[shelfIndex].collapsed = !s.bookshelves[bsIndex].shelves[shelfIndex].collapsed, false);
          render();
        };
        ctrls.append(addB, delShelf, coll); bar.append(name, ctrls); wrap.appendChild(bar);
        if (!shelf.collapsed) {
          const body = createEl('div', { className: 'shelf-body', 'data-shelf-id': shelf.id });
          (shelf.books || []).forEach((book, bookIndex) => body.appendChild(renderBook(book, bsIndex, shelfIndex, bookIndex, icons)));
          const addTile = createEl('div', { className: 'book-add', innerHTML: `<span class="icon">${icons.plus}</span>` });
          addTile.style.background = `linear-gradient(135deg, ${addG1}, ${addG2})`;
          addTile.onclick = addB.onclick;
          body.appendChild(addTile);
          wrap.appendChild(body);
        }
        return wrap;
      }
      
      function renderBook(book, bsIndex, shelfIndex, bookIndex, icons) {
        const [a, b] = book.gradient || crossBasketGradient();
        const el = createEl('div', { className: 'book', textContent: book.title, 'data-book-id': book.id });
        el.style.background = `linear-gradient(135deg, ${a}, ${b})`;
        el.onclick = () => editBook(book, bsIndex, shelfIndex, bookIndex);
        return el;
      }
      
      function renderSearchResults(query, container, icons) {
          const tagMatches = [], otherMatches = [], matchedBookIds = new Set();
          state.bookshelves.forEach((bs, bi) => (bs.shelves || []).forEach((sh, si) => (sh.books || []).forEach((bk, ki) => {
              if ((bk.tags || []).some(tag => tag.toLowerCase().includes(query))) { tagMatches.push({ bi, si, ki, bs, sh, bk }); matchedBookIds.add(bk.id); }
          })));
          state.bookshelves.forEach((bs, bi) => (bs.shelves || []).forEach((sh, si) => (sh.books || []).forEach((bk, ki) => {
              if (matchedBookIds.has(bk.id)) return;
              if ((bk.title || '').toLowerCase().includes(query) || (bk.content || '').toLowerCase().includes(query)) { otherMatches.push({ bi, si, ki, bs, sh, bk }); }
          })));
          const results = [...tagMatches, ...otherMatches];
          main.querySelector('.bs-header .bs-title').textContent = `Search results for ${safe(query)}  ${results.length} found`;
          const body = createEl('div', { className: 'shelf-body', style: 'display: flex; flex-wrap: wrap; gap: 16px;' });
          results.forEach(({ bk, bi, si, ki, bs, sh }) => {
              const card = renderBook(bk, bi, si, ki, icons);
              card.title = `${bs.name}  ${sh.name}  ${bk.title}`;
              card.style.width = 'calc(33.333% - 11px)';
              body.appendChild(card);
          });
          container.appendChild(body);
      }
      
      function showTagsModal() {
        const modal = createEl('div', { className: 'modal' });
        modal.innerHTML = `<h3>All Tags</h3>`;
        const allTags = new Set();
        state.bookshelves.forEach(bs => {
          (bs.shelves || []).forEach(sh => {
            (sh.books || []).forEach(bk => {
              (bk.tags || []).forEach(tag => allTags.add(tag));
            });
          });
        });
        const tagsContainer = createEl('div', { className: 'global-tags-list' });
        if (allTags.size === 0) {
          tagsContainer.innerHTML = '<p>No tags yet.</p>';
        } else {
          Array.from(allTags).sort().forEach(tag => {
            const tagBtn = createEl('button', { 
              className: 'tag-btn', textContent: `#${tag}`,
              onclick: () => { globalSearch.value = tag; render(); hideOverlay(); }
            });
            tagsContainer.appendChild(tagBtn);
          });
        }
        const actions = createEl('div', { className: 'actions' });
        const closeBtn = createEl('button', { className: 'btn primary', textContent: 'Close' });
        closeBtn.onclick = hideOverlay;
        actions.appendChild(createEl('div')); actions.appendChild(closeBtn);
        modal.append(tagsContainer, actions); showOverlay(modal, hideOverlay);
      }
      
      function createBookInShelf(shelfIndex) {
        const currentBS = state.bookshelves[state.active];
        if (!currentBS || !currentBS.shelves || !currentBS.shelves[shelfIndex]) return;
        
        promptText('New Book', 'Book title').then(title => {
          if (title) {
            modifyState(s => {
              s.bookshelves[state.active].shelves[shelfIndex].books.push({
                id: newId(), title, content: '', tags: [], gradient: crossBasketGradient()
              });
            });
          }
        });
      }
      
      function saveToFile() {
        const dataStr = JSON.stringify(state, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = 'aethernote-backup.json';
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
      }
      
      function loadFromFile() {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = '.json';
        input.onchange = e => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = event => {
            try {
              const newState = JSON.parse(event.target.result);
              if (!newState.bookshelves || !Array.isArray(newState.bookshelves)) throw new Error('Invalid data structure');
              normalizeState(newState);
              modifyState(s => {
                s.bookshelves = newState.bookshelves;
                s.active = newState.active || 0;
                if (newState.activeTheme) s.activeTheme = newState.activeTheme;
              });
            } catch (err) {
              alert('Could not load file. It might be corrupted or in the wrong format.');
              console.error('Load error:', err);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }
      
     async function updateApp() {
        if (!('serviceWorker' in navigator)) {
          alert('This browser does not support updates.');
          return;
        }

        try {
          // 1. Ask the browser to check for a new service worker file on the server.
          const registration = await navigator.serviceWorker.getRegistration();
          if (!registration) {
            alert('No service worker found. Cannot update.');
            return;
          }

          // This will trigger the browser to fetch sw.js in the background.
          await registration.update();

          if (registration.waiting) {
            // If a new worker is already waiting, we can activate it.
            alert('A new version is ready. The app will now reload.');
            // Send a message to the waiting service worker to take over.
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
            // The service worker will take over, and we can reload.
            window.location.reload();
          } else if (registration.installing) {
            // A new worker is installing. We can listen for it to finish.
            console.log('New version found, installing...');
            alert('Update found! The app will reload automatically when it is ready.');
          } else {
            alert('You already have the latest version of the app.');
          }
        } catch (error) {
          console.error('Update failed:', error);
          alert('Failed to check for updates. Please check your network connection.');
        }
      }

      async function initApp() {
        loadFromStorage(); 
        loadUserThemes();
        systemThemes = await loadSystemThemes();
        
        applyTheme(getThemeByName(state.activeTheme));
        const icons = getIconsForTheme(getThemeByName(state.activeTheme));
        document.getElementById('menuBtn').innerHTML = `<span class="icon">${icons.menu}</span>`;
        document.getElementById('saveBtn').innerHTML = `<span class="icon">${icons.save}</span> Save`;
        document.getElementById('loadBtn').innerHTML = `<span class="icon">${icons.load}</span> Load`;
        document.getElementById('themesBtn').innerHTML = `<span class="icon">${icons.themes}</span> Themes`;
        document.getElementById('tagsBtn').innerHTML = `<span class="icon">${icons.tags}</span> Tags`;
        document.getElementById('updateBtn').innerHTML = `<span class="icon">${icons.update}</span> Update`;
        document.getElementById('menuBtn').onclick = function(e) { e.stopPropagation(); document.getElementById('menuDropdown').classList.toggle('show'); };
        window.onclick = () => document.getElementById('menuDropdown').classList.remove('show');
        
        // Search bar logic
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        globalSearch.addEventListener('input', () => {
          render();
          clearSearchBtn.style.display = globalSearch.value.length > 0 ? 'block' : 'none';
        });
        clearSearchBtn.addEventListener('click', () => {
          globalSearch.value = '';
          clearSearchBtn.style.display = 'none';
          render();
          globalSearch.focus();
        });

        document.getElementById('saveBtn').onclick = saveToFile;
        document.getElementById('loadBtn').onclick = loadFromFile;
        document.getElementById('updateBtn').onclick = updateApp;
        document.getElementById('themesBtn').onclick = showThemesModal;
        document.getElementById('tagsBtn').onclick = showTagsModal;
        
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape') {
            if (isModalOpen && typeof activeModalCloseHandler === 'function') {
              activeModalCloseHandler();
            }
          }
        });
        
        window.addEventListener('keydown', e => {
            if (isModalOpen || e.target.matches('input, textarea') || globalSearch.value) return;
            const key = e.key.toLowerCase();
            if (key === 'n') { e.preventDefault(); main.querySelector('.bs-controls .btn-header')?.click(); } 
            else if (key >= '1' && key <= '9') { e.preventDefault(); createBookInShelf(parseInt(key) - 1); } 
            else if (key === '0') { e.preventDefault(); createBookInShelf(9); }
        });
        render();
      }
      initApp();
    })();
  </script>
</body>
</html>
